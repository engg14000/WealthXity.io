{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title mb-0"><i class="bi bi-lightning"></i> Future Forecast</h1>
    <form class="d-flex align-items-center">
        <label class="me-2">Forecast Years:</label>
        <select name="years" class="form-select" style="width: auto;" onchange="this.form.submit()">
            <option value="5" {% if forecast_years == 5 %}selected{% endif %}>5 Years</option>
            <option value="10" {% if forecast_years == 10 %}selected{% endif %}>10 Years</option>
            <option value="15" {% if forecast_years == 15 %}selected{% endif %}>15 Years</option>
            <option value="20" {% if forecast_years == 20 %}selected{% endif %}>20 Years</option>
            <option value="25" {% if forecast_years == 25 %}selected{% endif %}>25 Years</option>
            <option value="30" {% if forecast_years == 30 %}selected{% endif %}>30 Years</option>
        </select>
    </form>
</div>

<!-- Current vs Future -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card summary-card">
            <div class="card-body text-center">
                <h6 class="text-white-50">Current Net Worth</h6>
                <h2>₹ {{ "{:,.0f}".format(summary.net_worth) }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card summary-card success">
            <div class="card-body text-center">
                <h6 class="text-white-50">Projected in {{ forecast_years }} Years</h6>
                {% if projections %}
                <h2>₹ {{ "{:,.0f}".format(projections[-1].total) }}</h2>
                {% else %}
                <h2>₹ 0</h2>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if assets %}
<!-- Asset-wise Expected Returns -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-percent"></i> Expected Annual Returns (Used for Forecast)
    </div>
    <div class="card-body">
        <div class="row">
            {% for asset_name, asset_info in assets.items() %}
            <div class="col-md-4 mb-3">
                <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                    <span>{{ asset_name }}</span>
                    <span class="badge bg-primary">{{ "%.1f"|format(asset_info.expected_return) }}% p.a.</span>
                </div>
            </div>
            {% endfor %}
        </div>
        <small class="text-muted">
            <i class="bi bi-info-circle"></i> These returns are based on your asset-level expected returns. 
            You can update them when editing individual assets.
        </small>
    </div>
</div>

<!-- Forecast Chart -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-graph-up"></i> Portfolio Growth Projection
    </div>
    <div class="card-body">
        <canvas id="forecastChart" height="100"></canvas>
    </div>
</div>

<!-- Year-by-Year Projection Table -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-table"></i> Year-by-Year Projection
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Year</th>
                        {% for asset_name in assets.keys() %}
                        <th class="text-end">{{ asset_name }}</th>
                        {% endfor %}
                        <th class="text-end">Total</th>
                        <th class="text-end">Growth</th>
                    </tr>
                </thead>
                <tbody>
                    {% for proj in projections %}
                    <tr {% if loop.last %}class="table-success fw-bold"{% endif %}>
                        <td>{{ proj.year }} {% if proj.year == 0 %}(Now){% endif %}</td>
                        {% for asset_name in assets.keys() %}
                        <td class="text-end">₹ {{ "{:,.0f}".format(proj[asset_name]) }}</td>
                        {% endfor %}
                        <td class="text-end">₹ {{ "{:,.0f}".format(proj.total) }}</td>
                        <td class="text-end">
                            {% if proj.year > 0 %}
                            <span class="text-success">+{{ "{:,.0f}".format(proj.total - projections[0].total) }}</span>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Growth Multiplier -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-calculator"></i> Growth Summary
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-4">
                <h4 class="text-primary">{{ "%.1f"|format(projections[-1].total / projections[0].total if projections[0].total > 0 else 0) }}x</h4>
                <p class="text-muted mb-0">Growth Multiplier</p>
            </div>
            <div class="col-md-4">
                <h4 class="text-success">₹ {{ "{:,.0f}".format(projections[-1].total - projections[0].total if projections else 0) }}</h4>
                <p class="text-muted mb-0">Absolute Growth</p>
            </div>
            <div class="col-md-4">
                {% set cagr = ((projections[-1].total / projections[0].total) ** (1/forecast_years) - 1) * 100 if projections and projections[0].total > 0 else 0 %}
                <h4 class="text-warning">{{ "%.1f"|format(cagr) }}%</h4>
                <p class="text-muted mb-0">Portfolio CAGR</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('forecastChart').getContext('2d');
    const projections = {{ projections|tojson }};
    const assetNames = {{ assets.keys()|list|tojson }};
    
    const colors = [
        '#3498db', '#27ae60', '#e74c3c', '#f39c12', '#9b59b6', 
        '#1abc9c', '#e67e22', '#34495e', '#16a085', '#c0392b'
    ];
    
    const datasets = assetNames.map((name, idx) => ({
        label: name,
        data: projections.map(p => p[name]),
        backgroundColor: colors[idx % colors.length],
        borderColor: colors[idx % colors.length],
        borderWidth: 1
    }));
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: projections.map(p => 'Year ' + p.year),
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                x: { stacked: true },
                y: { 
                    stacked: true,
                    ticks: {
                        callback: function(value) {
                            if (value >= 10000000) return '₹' + (value/10000000).toFixed(1) + 'Cr';
                            if (value >= 100000) return '₹' + (value/100000).toFixed(1) + 'L';
                            return '₹' + value.toLocaleString('en-IN');
                        }
                    }
                }
            }
        }
    });
</script>

{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-lightning display-1 text-muted"></i>
        <h4 class="mt-3">No Assets to Forecast</h4>
        <p class="text-muted">Add some investments to see your future portfolio projections.</p>
        <a href="{{ url_for('add_item') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add Assets
        </a>
    </div>
</div>
{% endif %}
{% endblock %}
