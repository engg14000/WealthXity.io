{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title mb-0">
        {% if item_type == 'mf' %}<i class="bi bi-graph-up-arrow"></i>
        {% elif item_type == 'bank' %}<i class="bi bi-bank"></i>
        {% elif item_type == 'nps' %}<i class="bi bi-piggy-bank"></i>
        {% elif item_type == 'insurance' %}<i class="bi bi-shield-check"></i>
        {% elif item_type == 'cc' %}<i class="bi bi-credit-card"></i>
        {% elif item_type == 'loan' %}<i class="bi bi-cash-stack"></i>
        {% endif %}
        {{ sheet_name }}
    </h1>
    <a href="{{ url_for('add_item', type=item_type) }}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Add New
    </a>
</div>

<div class="card">
    <div class="card-body p-0" id="items-container">
        {% if storage_mode == 'firebase' %}
            {# Firebase mode: server rendered #}
            {% if items %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                {% for key in items[0].keys() %}
                                    <th>{{ key.replace('_', ' ')|title }}</th>
                                {% endfor %}
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    {% for value in item.values() %}
                                        <td>{{ value }}</td>
                                    {% endfor %}
                                    <td class="text-center">
                                        <a href="{{ url_for('edit_item', item_type=item_type, row_index=loop.index0) }}" 
                                           class="btn btn-sm btn-outline-primary btn-action me-1" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <a href="{{ url_for('delete_item', item_type=item_type, row_index=loop.index0) }}" 
                                           class="btn btn-sm btn-outline-danger btn-action" 
                                           onclick="return confirm('Are you sure you want to delete this item?')" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h4 class="mt-3">No {{ sheet_name }} Found</h4>
                    <p class="text-muted">Start by adding your first item.</p>
                    <a href="{{ url_for('add_item', type=item_type) }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Add New
                    </a>
                </div>
            {% endif %}
        {% else %}
            {# Browser mode: loading placeholder #}
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading items...</p>
            </div>
        {% endif %}
    </div>
</div>

{% if storage_mode == 'firebase' and items %}
<div class="mt-3 text-muted">
    <small>Total: {{ items|length }} item(s)</small>
</div>
{% else %}
<div id="items-count" class="mt-3 text-muted" style="display: none;">
    <small>Total: <span id="count-value">0</span> item(s)</small>
</div>
{% endif %}

{% if storage_mode != 'firebase' %}
<script>
const itemType = '{{ item_type }}';
const sheetName = '{{ sheet_name }}';

function loadItems() {
    const items = getSheetData(sheetName);
    const container = document.getElementById('items-container');
    const countDiv = document.getElementById('items-count');
    const countValue = document.getElementById('count-value');
    
    if (!items || items.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-inbox display-1 text-muted"></i>
                <h4 class="mt-3">No ${sheetName} Found</h4>
                <p class="text-muted">Start by adding your first item.</p>
                <a href="/add?type=${itemType}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Add New
                </a>
            </div>`;
        countDiv.style.display = 'none';
        return;
    }
    
    const keys = Object.keys(items[0]);
    
    let tableRows = items.map((item, idx) => `
        <tr>
            <td>${idx + 1}</td>
            ${keys.map(k => `<td>${item[k] ?? ''}</td>`).join('')}
            <td class="text-center">
                <a href="/edit/${itemType}/${idx}" class="btn btn-sm btn-outline-primary btn-action me-1" title="Edit">
                    <i class="bi bi-pencil"></i>
                </a>
                <button onclick="handleDelete(${idx})" class="btn btn-sm btn-outline-danger btn-action" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    container.innerHTML = `
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>#</th>
                        ${keys.map(k => `<th>${k.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</th>`).join('')}
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>${tableRows}</tbody>
            </table>
        </div>`;
    
    countDiv.style.display = 'block';
    countValue.textContent = items.length;
}

function handleDelete(index) {
    if (!confirm('Are you sure you want to delete this item?')) return;
    deleteItem(sheetName, index);
    loadItems();
}

document.addEventListener('DOMContentLoaded', loadItems);
</script>
{% endif %}
{% endblock %}
